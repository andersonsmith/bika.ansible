# Redirect per default to HTTPS
server {
    server_name _;
    listen 80 default_server;
    listen [::]:80 default_server ipv6only=on;
    return 301 https://$host$request_uri;
}

# Bika Administrative HTTPS VHOST
server {
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server ipv6only=on;

    ssl_certificate {{ bika_ssl_certificate }};
    ssl_certificate_key {{ bika_ssl_certificate_key }};

    ssl_session_timeout 10m;
    ssl_protocols SSLv3 TLSv1;
    ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
    ssl_prefer_server_ciphers on;

    root {{ bika_nginx_html_root }};

    location / {
        set $backend http://varnish;
        if ($uri ~* "@@API") {
            set $backend http://api;
        }

        if ($http_cookie ~* "__ac=([^;]+)(?:;|$)" ) {
            add_header "X-BIKA-AUTHENTICATED" "YES";
        }

        proxy_set_header        Host            $http_host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        rewrite                 ^(.*)$ /VirtualHostBase/$scheme/$host/{{ bika_plone_site_id }}/VirtualHostRoot/$1 break;
        proxy_pass              $backend;
    }

{% for client in range(0, bika_plone_client_count|int ) %}
    location /{{ bika_plone_instance_name }}_{{ client + 1 }} {
        proxy_set_header Host $http_host/{{ bika_plone_instance_name }}_{{ client + 1 }};
        proxy_pass       http://127.0.0.1:{{ bika_plone_client_base_port | int + client }}/;
    }
{% endfor %}

    # Bika Control Panel
    location /bika_control_panel {
        try_files $uri $uri.html /;
    }

    # Bika HAProxy
    location /haproxy {
        proxy_set_header        Host            $host/haproxy;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass              http://haproxy/;
    }

{% if bika_supervisor_with_http  %}
    # Supervisor
    location /supervisor/ {
        index index.html;
        proxy_set_header       Host            $host/supervisor;
        proxy_set_header       X-Real-IP       $remote_addr;
        proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass             http://{{ bika_supervisor_http_port }}/;
    }
{% endif %}

{% if bika_haproxy_with_http_stats %}
    # HAProxy
    location /haproxy-status {
        proxy_set_header        Host            $http_host;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass              http://haproxy/haproxy-status;
    }
{% endif %}

}
